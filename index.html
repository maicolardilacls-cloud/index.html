<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Turno en la Noche - Prototipo (Completo)</title>
<style>
  body{font-family:Inter,system-ui,Segoe UI,Arial;margin:0;background:#0f172a;color:#e6eef8;display:flex;flex-direction:column;align-items:center;padding:20px}
  .container{max-width:920px;width:100%}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  h1{font-size:20px;margin:0}
  .game{background:#081028;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.5)}
  .toprow{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .bar{background:#0b1624;border-radius:8px;padding:6px;width:100%}
  .meter{height:18px;border-radius:8px;background:linear-gradient(90deg,#f97316,#ef4444);width:0%}
  .label{font-size:13px}
  .controls{display:flex;gap:8px}
  button{background:#1f2937;border:0;color:#e6eef8;padding:8px 10px;border-radius:8px;cursor:pointer}
  button:active{transform:translateY(1px)}
  .tasks{margin-top:12px}
  .task{background:#07122b;padding:10px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
  .minigame{margin-top:12px;padding:10px;background:#07112a;border-radius:8px;display:flex;flex-direction:column;align-items:center}
  .alert{background:#1a2a3a;padding:8px;border-radius:8px;margin-top:10px}
  .footer{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .scoreboard{background:#071228;padding:10px;border-radius:8px;margin-top:12px}
  .small{font-size:13px;color:#9fb0c3}
  .danger{color:#ffb4b4}
  .success{color:#b6f0c6}
  .hidden{display:none}
  .big{font-size:24px;font-weight:700}
  /* End screen styling */
  #endScreen{position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.88); display:none; color:white; z-index:2000; align-items:center; justify-content:center; text-align:center;}
  #endScreen .panel{background:#111; padding:30px; border-radius:16px; width:90%; max-width:480px; box-shadow:0 10px 30px rgba(0,0,0,.7);}
  #timerEl{font-weight:700}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Turno en la Noche ‚Äî Prototipo educativo</h1>
    <div class="small">Objetivo: completa tareas sin causar incidentes</div>
  </header>

  <div class="game" id="game">
    <div class="toprow">
      <div style="flex:1">
        <div class="label">Fatiga</div>
        <div class="bar" title="Fatiga actual">
          <div id="fatigaMeter" class="meter" style="width:10%"></div>
        </div>
        <div class="small" id="fatigaValue">Fatiga: 30%</div>
      </div>

      <div style="width:260px">
        <div class="label">Recursos</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <button id="btnCafe">Tomar caf√© ‚òï</button>
          <button id="btnSiesta">Siesta 20 min üí§</button>
          <button id="btnPausa">Pausa 5 min ‚è∏Ô∏è</button>
        </div>
        <div class="small" style="margin-top:6px">
          Caf√© restante: <span id="cafeCount">3</span> |
          Siestas: <span id="siestaCount">2</span>
        </div>
        <div class="small" style="margin-top:6px">
          Tiempo restante: <span id="timerEl">04:00</span>
        </div>
      </div>
    </div>

    <div class="tasks">
      <div class="label">Tareas del turno</div>
      <div id="tasksList"></div>
    </div>

    <div class="minigame" id="minigame">
      <div class="label">Minijuego: Prueba de reacci√≥n</div>
      <div style="margin-top:8px">
        <div class="big" id="minigameMsg">Presiona "Iniciar prueba" para comenzar</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="btnStartTest">Iniciar prueba</button>
          <button id="btnPress" disabled>Presiona aqu√≠ cuando veas GO</button>
        </div>
        <div class="small" id="reactionResult"></div>
      </div>
    </div>

    <div class="alert" id="message">Bienvenido: administra tu energ√≠a y evita incidentes. Una fatiga mayor aumenta la probabilidad de errores.</div>

    <div class="footer">
      <div class="small">Turno: <span id="turnNum">1</span></div>
      <div class="small">Tareas completadas: <span id="completed">0</span></div>
      <div class="small">Incidentes: <span id="incidents">0</span></div>
      <div style="flex:1"></div>
      <button id="advanceTime">Avanzar 10 min ‚è≠Ô∏è</button>
      <button id="resetGame">Reiniciar</button>
    </div>

    <div class="scoreboard" id="scoreboard">
      <div class="small">Reporte r√°pido</div>
      <div>Fatiga promedio: <span id="fatAvg">‚Äî</span></div>
      <div>Tasa de fallos: <span id="failRate">‚Äî</span></div>
    </div>
  </div>

  <div style="margin-top:16px;color:#9fb0c3">
    Consejos: siesta corta (20‚Äì30 min) reduce fatiga sin afectar productividad; la cafe√≠na ayuda a corto plazo; priorizar pausas y buena iluminaci√≥n.
  </div>
</div>

<!-- Pantalla de fin (victoria / derrota) -->
<div id="endScreen" role="dialog" aria-modal="true">
  <div class="panel">
    <h2 id="endTitle">Fin del turno</h2>
    <p id="endMsg">Mensaje</p>
    <div style="margin-top:18px">
      <button id="btnRestart" style="background:#ff6600; color:white; border:none; padding:10px 18px; border-radius:10px; cursor:pointer;">Reiniciar juego</button>
    </div>
  </div>
</div>

<!-- Gu√≠a r√°pida (overlay inicial) -->
<div id="guia" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; display:flex; align-items:center; justify-content:center; z-index:1000;">
  <div style="background:#222; padding:30px; border-radius:20px; max-width:500px; text-align:left; box-shadow:0 0 20px black;">
    <h2>üí§ Gu√≠a r√°pida</h2>
    <p><strong>Objetivo:</strong> Termina tu turno nocturno sin llegar a fatiga extrema ni cometer errores.</p>
    <ul>
      <li>‚òï <b>Tomar caf√©:</b> Reduce fatiga temporalmente.</li>
      <li>üí§ <b>Siesta 20 min:</b> Restaura energ√≠a, pero consume tiempo.</li>
      <li>‚è∏Ô∏è <b>Pausa 5 min:</b> Recupera un poco de energ√≠a.</li>
      <li>üìã <b>Realizar tarea:</b> Ganas puntos, pero aumentas la fatiga.</li>
      <li>‚ö° <b>Prueba de reacci√≥n:</b> Eval√∫a tu nivel de atenci√≥n.</li>
    </ul>
    <p>Si la fatiga llega al m√°ximo, aumenta el riesgo de errores laborales.</p>
    <button onclick="cerrarGuia()" style="background:#ff8800; color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; margin-top:10px;">Cerrar gu√≠a</button>
  </div>
</div>

<!-- Bot√≥n para abrir la gu√≠a -->
<button onclick="abrirGuia()" style="position:fixed; bottom:20px; right:20px; background:#555; color:white; border:none; border-radius:50%; width:50px; height:50px; font-size:24px; cursor:pointer; z-index:500;">‚ÑπÔ∏è</button>

<div class="controles" style="position:fixed; left:20px; bottom:20px;">
  <label for="dificultad" class="small">Dificultad:</label>
  <select id="dificultad">
    <option value="facil">F√°cil</option>
    <option value="medio" selected>Medio</option>
    <option value="dificil">Dif√≠cil</option>
  </select>
</div>

<script>
(function(){
  // ---------- Estado del juego ----------
  let fatiga = 30; // 0-100
  let timeMinutes = 0;
  let tasks = [];
  let completed = 0;
  let incidents = 0;
  let cafeCount = 3;
  let siestaCount = 2;
  let totalFatigaSamples = 0;
  let fatigaSum = 0;
  let turn = 1;

  // Temporizador de partida (4 minutos reales)
  let partidaDuracion = 240; // segundos
  let tiempoRestante = partidaDuracion;
  let timerInterval = null;
  let gameEnded = false;

  // ---------- Elementos ----------
  const fatigaMeter = document.getElementById('fatigaMeter');
  const fatigaValue = document.getElementById('fatigaValue');
  const btnCafe = document.getElementById('btnCafe');
  const btnSiesta = document.getElementById('btnSiesta');
  const btnPausa = document.getElementById('btnPausa');
  const tasksList = document.getElementById('tasksList');
  const message = document.getElementById('message');
  const completedEl = document.getElementById('completed');
  const incidentsEl = document.getElementById('incidents');
  const cafeCountEl = document.getElementById('cafeCount');
  const siestaCountEl = document.getElementById('siestaCount');
  const advanceBtn = document.getElementById('advanceTime');
  const resetBtn = document.getElementById('resetGame');
  const turnNum = document.getElementById('turnNum');
  const fatAvgEl = document.getElementById('fatAvg');
  const failRate = document.getElementById('failRate');
  const timerEl = document.getElementById('timerEl');

  // Minijuego
  const btnStartTest = document.getElementById('btnStartTest');
  const btnPress = document.getElementById('btnPress');
  const minigameMsg = document.getElementById('minigameMsg');
  const reactionResult = document.getElementById('reactionResult');
  let testPending = false;
  let goTime = 0;
  let waitingForGo = false;

  // End screen
  const endScreen = document.getElementById('endScreen');
  const endTitle = document.getElementById('endTitle');
  const endMsg = document.getElementById('endMsg');
  const btnRestart = document.getElementById('btnRestart');

  // ---------- Funciones core ----------
  function setFatiga(v){
    fatiga = Math.max(0, Math.min(100, Math.round(v)));
    fatigaMeter.style.width = fatiga + '%';
    fatigaValue.textContent = 'Fatiga: ' + fatiga + '%';

    // Detecci√≥n de fin del juego por fatiga extrema
    if(fatiga >= 100 && !gameEnded){
      mostrarFin("‚ùå Fatiga extrema", "Has alcanzado el 100% de fatiga. Esto provoca errores cr√≠ticos. Turno terminado.");
      return;
    }

    // acumula sample solo si a√∫n no termin√≥
    if(!gameEnded){
      fatigaSum += fatiga;
      totalFatigaSamples++;
      updateScoreboard();
    }
  }

  function updateScoreboard(){
    const avg = totalFatigaSamples ? (fatigaSum/totalFatigaSamples).toFixed(0)+'%' : '‚Äî';
    fatAvgEl.textContent = avg;
    const fails = (incidents + completed) ? Math.round( (incidents / (incidents+completed))*100 ) + '%' : '‚Äî';
    failRate.textContent = fails;
  }

  function logMessage(txt, urgent=false){
    message.textContent = txt;
    message.style.background = urgent ? '#4c1f1f' : '#123246';
  }

  function spawnTasks(n=3){
    // Si el juego ya termin√≥, no generar m√°s tareas
    if(gameEnded) return;
    for(let i=0;i<n;i++){
      const difficulty = 1 + Math.floor(Math.random()*3); // 1..3
      const timeLimit = 20 + difficulty*10; // minutes
      tasks.push({id:Date.now()+Math.random(),name:'Tarea ' + (tasks.length+1), difficulty, timeLeft:timeLimit, started:false});
    }
    renderTasks();
  }

  function renderTasks(){
    tasksList.innerHTML = '';
    tasks.forEach((t, idx) => {
      const div = document.createElement('div'); div.className='task';
      const left = document.createElement('div');
      left.innerHTML = `<strong>${t.name}</strong><div class="small">Dificultad: ${t.difficulty} | Tiempo restante: <span id="t_${idx}">${t.timeLeft}</span> min</div>`;
      const right = document.createElement('div');
      const btnDo = document.createElement('button');
      btnDo.textContent = 'Realizar';
      btnDo.onclick = () => doTask(idx);
      right.appendChild(btnDo);
      div.appendChild(left); div.appendChild(right);
      tasksList.appendChild(div);
    });
    if(tasks.length===0) tasksList.innerHTML = '<div class="small">No hay tareas. Avanza tiempo para generar nuevas tareas.</div>';
  }

  function doTask(idx){
    if(gameEnded) return;
    const t = tasks[idx];
    if(!t) return;
    // Probabilidad de error depende de fatiga y dificultad
    const baseFail = 0.5 * t.difficulty; // base
    const fatigaFactor = (fatiga/100) * 1.8;
    const probFail = Math.min(0.99, baseFail + fatigaFactor);
    const rnd = Math.random();
    // simulate time spent
    const minutosGastados = 10 * t.difficulty;
    timeMinutes += minutosGastados;
    advanceTimeEffects(minutosGastados, false);

    if(rnd < probFail){
      // error -> incidente
      incidents++;
      incidentsEl.textContent = incidents;
      // los incidentes aumentan fatiga levemente
      setFatiga(fatiga + 8);
      logMessage(`Incidente: error en ${t.name} por fatiga (prob ${Math.round(probFail*100)}%).`, true);
    } else {
      completed++;
      completedEl.textContent = completed;
      logMessage(`Completaste ${t.name} correctamente. ¬°Buen manejo!`, false);
      // √©xito reduce un poco la fatiga por satisfacci√≥n
      setFatiga(fatiga - 3);
    }
    // remove task
    tasks.splice(idx,1);
    renderTasks();
    updateScoreboard();

    // Si no quedan tareas y el tiempo a√∫n no termin√≥ puede considerarse buen desempe√±o,
    // pero la victoria por tiempo es la condici√≥n principal (4 minutos).
  }

  /**
   * advanceTimeEffects(minutes, isResting)
   * - minutes: n√∫mero de minutos que avanzan
   * - isResting: si true => no subir fatiga ni vencer tareas (pausa/siesta)
   */
  function advanceTimeEffects(minutes, isResting = false){
    // Si el juego termin√≥, no hacer nada
    if(gameEnded) return;

    // Aumenta fatiga con el paso del tiempo solo si no estamos en descanso
    if(!isResting){
      // f√≥rmula moderada para incrementar fatiga
      const inc = 6 * (minutes/10) * (1 + Math.random()*0.6); // ajustable
      setFatiga(fatiga + inc);
    }

    // Avance de tiempo y vencimiento de tareas SOLO si no es descanso
    if(!isResting){
      for(let idx = tasks.length - 1; idx >= 0; idx--){
        const t = tasks[idx];
        t.timeLeft = Math.max(0, t.timeLeft - Math.round(minutes * 1.5));
        const span = document.getElementById('t_'+idx);
        if(span) span.textContent = t.timeLeft;
        if(t.timeLeft <= 0){
          // auto-fail si se vence
          incidents++;
          incidentsEl.textContent = incidents;
          // penalizaci√≥n por tarea vencida
          setFatiga(fatiga + 9);
          logMessage(`‚ùå Incidente: ${t.name} venci√≥ el tiempo por exceso de carga.`, true);
          tasks.splice(idx, 1);
          renderTasks();
        }
      }
    }

    // Actualizar scoreboard si corresponde
    updateScoreboard();
  }

  // ---------- Recursos / botones ----------
  btnCafe.onclick = () => {
    if(gameEnded) return;
    if(cafeCount<=0){ logMessage('No tienes m√°s caf√© disponible.'); return; }
    cafeCount--; cafeCountEl.textContent = cafeCount;
    // Caf√© reduce fatiga temporalmente
    setFatiga(fatiga - 12);
    logMessage('Tomaste caf√©: mejora temporal de alerta. Recuerda no depender solo de cafe√≠na.');
  };

  btnSiesta.onclick = () => {
    if(gameEnded) return;
    if(siestaCount<=0){ logMessage('No tienes m√°s siestas programadas.'); return; }
    siestaCount--; siestaCountEl.textContent = siestaCount;
    // Siesta consume tiempo real en el turno, pero no deber√≠a penalizar tareas ni incrementar fatiga
    timeMinutes += 20;
    advanceTimeEffects(20, true); // modo descanso
    // Restauraci√≥n m√°s significativa
    setFatiga(fatiga - 15);
    logMessage('Hiciste una siesta corta: restauraci√≥n significativa de fatiga. (20 min)');
  };

  btnPausa.onclick = () => {
    if(gameEnded) return;
    timeMinutes += 5;
    // Pausa no debe incrementar fatiga ni vencer tareas
    advanceTimeEffects(5, true);
    setFatiga(fatiga - 6);
    logMessage('Tomaste una pausa breve: recuperaci√≥n sin penalizaci√≥n.');
  };

  advanceBtn.onclick = () => {
    if(gameEnded) return;
    timeMinutes += 10;
    advanceTimeEffects(10, false);
    // Generar nuevas tareas ocasionalmente
    if(Math.random() < 0.6 && tasks.length < 4){ spawnTasks(1); }
    logMessage('Avanzaste 10 minutos del turno.');
  };

  resetBtn.onclick = () => {
    if(gameEnded){
      location.reload();
      return;
    }
    if(!confirm('¬øReiniciar el prototipo?')) return;
    location.reload();
  };

  // ---------- Minijuego (reacci√≥n) ----------
  btnStartTest.onclick = () => {
    if(gameEnded) return;
    if(testPending) return;
    testPending = true;
    btnStartTest.disabled = true;
    btnPress.disabled = true;
    reactionResult.textContent = '';
    minigameMsg.textContent = 'Espera...';
    // random wait 1-3s
    const wait = 1000 + Math.random()*2000;
    waitingForGo = true;
    setTimeout(()=>{
      // reaction window depende de fatiga (mayor fatiga => peor ventana)
      const baseWindow = 800; // ms baseline
      const windowMs = Math.max(300, baseWindow - (fatiga * 12)); // ajustado
      minigameMsg.textContent = 'GO! Presiona ahora';
      goTime = performance.now();
      btnPress.disabled = false;
      // auto fail si no presiona en la ventana
      setTimeout(()=>{
        if(btnPress.disabled===false){
          // no presion√≥ en el tiempo
          btnPress.disabled = true;
          testPending = false;
          btnStartTest.disabled = false;
          reactionResult.textContent = 'No respondiste a tiempo. Probabilidad de error aumenta en tareas.';
          setFatiga(fatiga + 9);
          incidents++; incidentsEl.textContent = incidents;
          updateScoreboard();
        }
      }, windowMs);
    }, wait);
  };

  btnPress.onclick = () => {
    if(gameEnded) return;
    if(!waitingForGo) { reactionResult.textContent='Presionaste demasiado pronto: espera al GO.'; return; }
    const rt = performance.now() - goTime;
    btnPress.disabled = true;
    testPending = false;
    waitingForGo = false;
    btnStartTest.disabled = false;
    const rtRounded = Math.round(rt);
    reactionResult.textContent = 'Tu tiempo de reacci√≥n: ' + rtRounded + ' ms';
    const threshold = Math.max(300, 600 - fatiga*5);
    if(rt > threshold){
      // reacci√≥n lenta
      incidents++; incidentsEl.textContent = incidents;
      logMessage('Reacci√≥n lenta: la fatiga afecta tus tiempos de respuesta. Considera siesta o pausas.', true);
      setFatiga(fatiga + 8);
    } else {
      logMessage('Buena reacci√≥n. Mant√©n buenas pr√°cticas de sue√±o.');
      setFatiga(fatiga - 5);
    }
    updateScoreboard();
  };

  // ---------- Temporizador de 4 minutos ----------
  function formatTime(s){
    const mm = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(s % 60).padStart(2,'0');
    return `${mm}:${ss}`;
  }

  function iniciarTemporizador(){
    // Asegurar reinicio si ya hab√≠a uno
    clearInterval(timerInterval);
    tiempoRestante = partidaDuracion;
    timerEl.textContent = formatTime(tiempoRestante);
    timerInterval = setInterval(() => {
      if(gameEnded){ clearInterval(timerInterval); return; }
      tiempoRestante--;
      timerEl.textContent = formatTime(tiempoRestante);

      // cada 30 segundos aproximadamente generar un peque√±o avance temporal
      // (esto es opcional; aqu√≠ solo actualizamos la visual)
      if(tiempoRestante <= 0){
        clearInterval(timerInterval);
        if(!gameEnded){
          mostrarFin("üéâ Turno completado", "Has logrado completar los 4 minutos del turno. ¬°Buena gesti√≥n de la energ√≠a!");
        }
      }
    }, 1000);
  }

  // ---------- Mostrar fin del juego ----------
  function mostrarFin(title, msg){
    gameEnded = true;
    // detener timers
    clearInterval(timerInterval);

    // desactivar botones (mantener el reinicio habilitado)
    document.querySelectorAll("button").forEach(b => {
      b.disabled = true;
      b.style.opacity = '0.9';
    });
    // habilitar el bot√≥n reiniciar en la pantalla de fin
    btnRestart.disabled = false;

    // mostrar mensaje
    endTitle.textContent = title;
    endMsg.textContent = msg;
    endScreen.style.display = 'flex';
  }

  btnRestart.onclick = () => {
    location.reload();
  };

  // ---------- Inicio / reinicio ----------
  function start(){
    // reset estado
    tasks = [];
    completed = 0;
    incidents = 0;
    cafeCount = 3;
    siestaCount = 2;
    totalFatigaSamples = 0;
    fatigaSum = 0;
    turn = 1;
    gameEnded = false;

    completedEl.textContent = '0';
    incidentsEl.textContent = '0';
    cafeCountEl.textContent = cafeCount;
    siestaCountEl.textContent = siestaCount;
    turnNum.textContent = turn;
    reactionResult.textContent = '';
    minigameMsg.textContent = 'Presiona "Iniciar prueba" para comenzar';
    document.getElementById('guia').style.display = 'flex';

    // generar tareas iniciales
    spawnTasks(3);
    setFatiga(fatiga);

    // iniciar temporizador de 4 minutos
    iniciarTemporizador();
    logMessage('Turno iniciado. Administra tu fatiga y toma decisiones seguras.');
  }

  // controles GUI de gu√≠a
  window.cerrarGuia = function(){ document.getElementById('guia').style.display='none'; };
  window.abrirGuia = function(){ document.getElementById('guia').style.display='flex'; };

  // iniciar
  start();

  // seguridad: cuando la ventana pierde foco no detener el timer (se cuenta tiempo real)
  // Puedes a√±adir listeners adicionales si quieres pausar en background.

})();
</script>
</body>
</html>
